[novofon-in]
; Обработка входящих звонков на конкретный номер
exten => 79952227978,1,NoOp(Incoming call from Novofon to main number: ${CALLERID(all)})
same => n,Answer()
same => n,Wait(1)
same => n,Set(CHANNEL(language)=ru)
same => n,Playback(welcome)
same => n,Playback(agent-already)
same => n,Stasis(livekit-agent,${CALLERID(num)},${EXTEN})
same => n,Hangup()

; Обработка входящих звонков с префиксом +7
exten => +79952227978,1,Goto(novofon-in,79952227978,1)

; Обработка любых входящих звонков (для тестирования)
exten => _X.,1,NoOp(Incoming call from Novofon to any number: ${CALLERID(all)})
same => n,Answer()
same => n,Wait(1)
same => n,Set(CHANNEL(language)=ru)
same => n,Playback(welcome)
same => n,Playback(agent-already)
same => n,Stasis(livekit-agent,${CALLERID(num)},${EXTEN})
same => n,Hangup()

; Маршрутизация по имени номера (CALLERID(name))
exten => _X.,1,NoOp(Incoming call from Novofon with name: ${CALLERID(name)})
same => n,GotoIf($["${CALLERID(name)}" = "moscow"]?moscow,1)
same => n,GotoIf($["${CALLERID(name)}" = "saintpetersburg"]?spb,1)
same => n,Goto(default,1)

exten => moscow,1,NoOp(Call from Moscow number)
same => n,Answer()
same => n,Wait(1)
same => n,Set(CHANNEL(language)=ru)
same => n,Stasis(livekit-agent,${CALLERID(num)},moscow)
same => n,Hangup()

exten => spb,1,NoOp(Call from Saint Petersburg number)
same => n,Answer()
same => n,Wait(1)
same => n,Set(CHANNEL(language)=ru)
same => n,Stasis(livekit-agent,${CALLERID(num)},spb)
same => n,Hangup()

exten => default,1,NoOp(Call from unknown region)
same => n,Answer()
same => n,Wait(1)
same => n,Set(CHANNEL(language)=ru)
same => n,Stasis(livekit-agent,${CALLERID(num)},unknown)
same => n,Hangup()

; Маршрутизация по номеру (PJSIP_HEADER(read,CALLED_DID))
exten => _X.,1,NoOp(Incoming call to DID: ${PJSIP_HEADER(read,CALLED_DID)})
same => n,GotoIf($["${PJSIP_HEADER(read,CALLED_DID)}" = "79952227978"]?moscow_did,1)
same => n,GotoIf($["${PJSIP_HEADER(read,CALLED_DID)}" = "78121111111"]?spb_did,1)
same => n,Goto(default_did,1)

exten => moscow_did,1,NoOp(Call to Moscow DID)
same => n,Answer()
same => n,Wait(1)
same => n,Set(CHANNEL(language)=ru)
same => n,Stasis(livekit-agent,${CALLERID(num)},moscow_did)
same => n,Hangup()

exten => spb_did,1,NoOp(Call to Saint Petersburg DID)
same => n,Answer()
same => n,Wait(1)
same => n,Set(CHANNEL(language)=ru)
same => n,Stasis(livekit-agent,${CALLERID(num)},spb_did)
same => n,Hangup()

exten => default_did,1,NoOp(Call to unknown DID)
same => n,Answer()
same => n,Wait(1)
same => n,Set(CHANNEL(language)=ru)
same => n,Stasis(livekit-agent,${CALLERID(num)},unknown_did)
same => n,Hangup()

; Обработка анонимных звонков
exten => s,1,NoOp(Anonymous call from Novofon)
same => n,Answer()
same => n,Wait(1)
same => n,Set(CHANNEL(language)=ru)
same => n,Stasis(livekit-agent,anonymous,unknown)
same => n,Hangup()

[novofon-out]
; Звонки на внутренние номера (трехзначные)
exten => _XXX,1,NoOp(Call to internal extension ${EXTEN})
same => n,Dial(PJSIP/${EXTEN},30,tr)
same => n,Hangup()

; Звонки на внешние номера (четыре и более цифр)
exten => _XXXX.,1,NoOp(Outgoing call to ${EXTEN})
same => n,Set(CALLERID(num)=79952227978)
same => n,Dial(PJSIP/${EXTEN}@0053248,60,tr)
same => n,Hangup()

; Звонки на номера с префиксом 8 (российский формат)
exten => _8XXXXXXXXXX,1,NoOp(Outgoing call to Russian number ${EXTEN})
same => n,Set(CALLERID(num)=79952227978)
same => n,Set(OUTNUM=7${EXTEN:1})
same => n,Dial(PJSIP/${OUTNUM}@0053248,60,tr)
same => n,Hangup()

; Звонки на номера с префиксом + (международный формат)
exten => _+X.,1,NoOp(Outgoing international call to ${EXTEN})
same => n,Set(CALLERID(num)=79952227978)
same => n,Set(OUTNUM=${EXTEN:1})
same => n,Dial(PJSIP/${OUTNUM}@0053248,60,tr)
same => n,Hangup()