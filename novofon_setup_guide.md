# Руководство по настройке Novofon для Asterisk (PJSIP)

Данное руководство описывает настройку интеграции между Novofon и Asterisk с использованием PJSIP (вместо устаревшего SIP).

## Выполненные настройки

### 1. Настройка PJSIP транка (novofon_pjsip.conf)

Файл `novofon_pjsip.conf` содержит настройки для подключения к Novofon через PJSIP:

- **Транспорт**: UDP на порту 5060
- **Внешний IP**: 94.131.122.253
- **Учетные данные**: логин 0053248, пароль g2SeLbAHZb
- **SIP-сервер**: sip.novofon.ru:5060
- **Идентификация**: по доменному имени и IP-адресам Novofon

### 2. Настройка диалплана (novofon_extensions.conf)

Файл `novofon_extensions.conf` содержит правила маршрутизации входящих и исходящих звонков:

#### Входящие звонки (контекст novofon-in):
- Обработка звонков на номер 79952227978
- Маршрутизация по имени номера (CALLERID(name))
- Маршрутизация по номеру (PJSIP_HEADER(read,CALLED_DID))
- Обработка анонимных звонков

#### Исходящие звонки (контекст novofon-out):
- Звонки на внутренние номера (трехзначные)
- Звонки на внешние номера (четыре и более цифр)
- Звонки на номера с префиксом 8 (российский формат)
- Звонки на номера с префиксом + (международный формат)

### 3. Дополнительные настройки

- **Идентификация по IP** (novofon_identify.conf): правила для идентификации входящих звонков от Novofon по IP-адресам
- **SIP URI** (novofon_sip_uri.conf): настройки для работы через SIP URI (для серверов с белым IP)
- **Логирование** (novofon_logging.conf): настройки для отладки SIP-соединений

### 4. Включение конфигурации

Файл `include_custom.conf` был обновлен для включения всех конфигурационных файлов:
```
[general]
#include novofon_pjsip.conf
#include novofon_extensions.conf
#include novofon_identify.conf
#include novofon_sip_uri.conf
#include novofon_test_call.conf
#include novofon_logging.conf
```

## Проверка настроек

Для проверки настроек был создан скрипт `check_novofon_config.sh`, который выполняет следующие проверки:
- Наличие конфигурационных файлов
- Статус регистрации на Novofon
- Настройки транспорта
- Настройки endpoint
- Настройки identify
- Сетевые настройки
- Диалплан
- Логи

## Тестирование

### Тестирование входящих звонков:
1. Позвоните на номер 79952227978
2. Проверьте логи: `tail -f /var/log/asterisk/full`

### Тестирование исходящих звонков:
1. Выполните команду: `asterisk -rx "channel originate PJSIP/79XXXXXXXXX@0053248 application Wait 10"`
2. Замените 79XXXXXXXXX на реальный номер для тестирования
3. Проверьте логи: `tail -f /var/log/asterisk/full`

### Проверка регистрации:
```
asterisk -rx "pjsip show registrations"
```

### Перезагрузка конфигурации:
```
asterisk -rx "module reload"
```

## Мониторинг и обслуживание

Для мониторинга соединения с Novofon созданы скрипты:
- `monitor_novofon.sh`: проверяет статус регистрации и перезапускает соединение при необходимости
- `monitor_incoming_calls.sh`: отслеживает входящие звонки и отправляет уведомления при проблемах

## Безопасность

Для обеспечения безопасности:
- Разрешены только IP-адреса Novofon (37.139.38.0/24)
- Настроена аутентификация по паролю
- Включено логирование для отслеживания подозрительной активности

## Устранение неполадок

### Проблемы с регистрацией:
- Проверьте правильность логина и пароля
- Убедитесь в доступности sip.novofon.ru
- Проверьте настройки firewall
- Проверьте логи: `grep -a "0053248" /var/log/asterisk/full`

### Проблемы с входящими звонками:
- Проверьте статус регистрации
- Убедитесь, что контекст novofon-in правильно настроен
- Проверьте логи во время входящего звонка

### Проблемы с исходящими звонками:
- Проверьте статус регистрации
- Убедитесь, что контекст novofon-out правильно настроен
- Проверьте формат набираемого номера
- Проверьте логи во время исходящего звонка