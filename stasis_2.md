# Причина сбоя «Stasis initialization failed» и пошаговое исправление в Docker-контейнере

**Коротко:** Asterisk выходит сразу после запуска, потому что не может найти XML-документацию для конфигурационного объекта `[declined_message_types]` модуля *stasis*. Без этой документации функция `xmldoc_update_config_type()` возвращает ошибку — и инициализация Stasis прерывается, PBX завершает работу[1][2].  

У проблемы три типичных корня:
1. Файлы `core-en_US.xml` и другие XML-доки отсутствуют в контейнере или перекрыты volume-монтированием.  
2. XML-файлы есть, но владелец/права не позволяют пользователю `asterisk` читать их (часто после работы с bind-mount директорий на хосте)[2].  
3. Сборка сделана с поддержкой xmldoc, но вы явно удалили опцию `--disable-xmldoc` и при `make install`/`make samples` не скопировали документацию.

## 1. Диагностика внутри запущенного контейнера

```bash
# Зайти внутрь
docker-compose exec asterisk bash

# Проверить, видит ли Asterisk docs
ls -l /usr/share/asterisk/documentation | head
ls -l /var/lib/asterisk/documentation | head       # второй возможный путь

# Проверить права
namei -om /usr/share/asterisk/documentation/en_US/core-en_US.xml
```

Признаки ошибки:

* каталог `documentation` пуст либо смонтирован как volume с хоста;
* владельцем файлов является `root`, а контейнер стартует от uid 2600 (`asterisk`) — читаться они не могут;
* файл `stasis.conf.xml` или сам `core-en_US.xml` отсутствует.

## 2. Быстрое исправление (выберите подходящий вариант)

| Сценарий | Действие | Комментарий |
|----------|----------|-------------|
| Используется официальный пакетный образ (Debian/Alpine) | Установить пакет документации: `apt-get update && apt-get install -y asterisk -doc` или `apk add asterisk-doc` | Пакет добавит `*/documentation/*/*.xml` и правильные права[3]. |
| Собственный билд из исходников | Запустить в образе `make install` ещё раз **из того же исходного дерева** или отдельно `make install-core-docs` (если цель поддерживается) | `make install` автоматически копирует XML-файлы в `/usr/share/asterisk/documentation/en_US/`[4]. |
| Том с данными перекрывает `/usr/share/asterisk` или `/var/lib/asterisk` | 1) уберите bind-mount, либо 2) добавьте в смонтированную директорию подпуть `documentation` и скопируйте туда *.xml с корректными правами (`chown -R 2600:2600 ...`) | Именно volume-override стал причиной аналогичного краша у других пользователей[2]. |
| Желательно полностью отказаться от XML-доков | Пересоберите Asterisk с опцией `./configure --disable-xmldoc` → `make && make install` | Stasis перестанет требовать документацию, но вы потеряете встроенную справку в CLI. |

После внесения изменений перезапустите контейнер:

```bash
docker-compose restart asterisk
```

В логе должны исчезнуть строки  
`Cannot update type 'declined_message_types'...` и `Stasis initialization failed`.

## 3. Проверка после старта

1. Убедитесь, что Asterisk работает:  
   ```bash
   docker-compose exec asterisk asterisk -rx 'core show uptime'
   ```
2. Проверка доступности Stasis-шины:  
   ```bash
   asterisk -rx 'stasis statistics show topics'
   ```
   Если команда выводит таблицу топиков, Stasis инициализировался корректно.

## 4. Практические советы, чтобы не поймать ошибку вновь

* **Не монтируйте volume поверх системных путей** `/usr/share/asterisk` и `/var/lib/asterisk`, если не планируете полностью дублировать их содержимое. Ограничьтесь `/etc/asterisk` для конфигов и, при необходимости, `/var/spool/asterisk` для записей звонков.  
* При использовании CI-билдов добавьте в Dockerfile отдельный слой, который копирует директорию `xml/` вашей сборки в образ.  
* Если вы фильтруете события через `[declined_message_types]`, оставьте в конфиге только реально необходимые строки. Пустой раздел безопаснее, чем список, написанный «на будущее» — но без актуальной документации он тоже вызовет фатальную проверку

## 5. Итог

Ошибка **не связана с самим Stasis-пулом** либо параметрами `threadpool`, а вызвана отсутствием XML-описаний, обязательных при сборке с поддержкой документации. Установите или откройте доступ к файлам `core-*.xml` (и особенно частям, описывающим `declined_message_types`), затем перезапустите контейнер — Asterisk успешно пройдёт инициализацию Stasis и продолжит работу