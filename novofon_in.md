# Подробный мануал настройки NovoFon для входящих звонков и направления их на сервер с Asterisk

Данное руководство поможет вам настроить NovoFon для приема входящих звонков и их направления на ваш сервер с Asterisk. Рассмотрим все доступные способы настройки с учетом особенностей новой платформы NovoFon 2.0.

## Обзор возможностей направления входящих звонков

В системе NovoFon 2.0 доступно **пять основных способов** настройки входящих звонков для направления на сервер Asterisk[1]:

- **SIP URI** - для серверов с белыми IP-адресами
- **SIP TRUNK** - для подключения внешних серверов
- **Переадресация на сотрудника** - с настройкой переадресации на внешний номер
- **Сценарии звонков** - для создания сложной логики обработки
- **Переадресация на группу сотрудников** - с возможностью направления на внешний сервер

## Подготовка к настройке

### Требования к серверу

Перед началом настройки убедитесь, что ваш сервер с Asterisk готов к работе:

1. **Asterisk установлен и настроен** для работы с NovoFon
2. **Сетевые порты открыты**:
   - UDP 5060 (SIP-сигнализация)
   - UDP 10000-20000 (RTP-медиа)
3. **Firewall настроен** для приема соединений от NovoFon

### IP-адреса NovoFon для firewall

Для корректной работы необходимо разрешить следующие IP-адреса в вашем firewall[2]:

```
37.139.38.224
37.139.38.236
37.139.38.237
37.139.38.131
37.139.38.56
```

Рекомендуется также открыть всю подсеть NovoFon[2]:
```
37.139.38.0/24
```

### Данные для подключения

Для настройки вам понадобятся данные из личного кабинета NovoFon[3]:
- **Логин**: находится в разделе «Телефония → Пользователи АТС → Имя пользователя → Вкладка ВАТС»
- **Пароль**: указан на той же странице
- **SIP-сервер**: `sip.novofon.ru`
- **Виртуальный номер**: номер, на который будут поступать звонки

## Настройка через SIP URI (для белых IP-адресов)

### Когда использовать SIP URI

Этот метод подходит для серверов с белыми IP-адресами, которые доступны напрямую из интернета[4]. Преимущества:
- Простая настройка
- Минимум конфигурации
- Прямое подключение без промежуточных серверов

### Настройка в личном кабинете NovoFon

1. **Войдите в личный кабинет** по адресу `https://my.novofon.ru/`

2. **Перейдите в раздел** «Пользователи АТС»

3. **Выберите пользователя** и откройте вкладку «ВАТС»

4. **Нажмите на SIP-логин** и в появившемся окне поставьте галочку **«Разрешить входящие SIP-URI»**[2]

5. **Укажите настройки переадресации**:
   - Выберите способ обработки звонков
   - Настройте направление на ваш сервер

6. **Скопируйте адрес SIP URI** из поля, которое появится после сохранения

### Настройка виртуального номера

1. **Перейдите в раздел** «Виртуальные номера»

2. **Выберите нужный номер** и в колонке «Переадресация на» нажмите **«плюс»**

3. **Выберите опцию** «SIP URI»

4. **Укажите адрес** в формате: `номер@ваш_IP_адрес`

Например: `79001234567@192.168.1.100`

### Настройка Asterisk для SIP URI

Отредактируйте файл `/etc/asterisk/sip.conf`[4]:

```ini
[novofon]
host=sip.novofon.ru
type=peer
insecure=port,invite
context=novofon-in
disallow=all
allow=alaw
allow=ulaw
dtmfmode=auto
directmedia=no
nat=force_rport,comedia
```

В файле `/etc/asterisk/extensions.conf` настройте входящий маршрут[4]:

```ini
[novofon-in]
exten => 79001234567,1,Answer()
exten => 79001234567,n,Wait(1)
exten => 79001234567,n,Dial(SIP/101,30,tr)
exten => 79001234567,n,Voicemail(101@default,u)
exten => 79001234567,n,Hangup()
```

## Настройка через SIP TRUNK

### Возможности SIP TRUNK

В NovoFon 2.0 SIP TRUNK поддерживает прием входящих звонков[1]. Вы можете указать IP-адрес и порт вашего сервера для направления входящих вызовов.

### Создание SIP TRUNK

1. **Войдите в личный кабинет** и перейдите в раздел «Виртуальные номера»

2. **Выберите номер** и нажмите «плюс» в колонке «Переадресация на»

3. **Выберите** «SIP TRUNK»

4. **Укажите параметры подключения**:
   - IP-адрес вашего сервера
   - Порт (обычно 5060)
   - Дополнительные настройки безопасности

### Настройка Asterisk для SIP TRUNK

Создайте транк в файле `/etc/asterisk/sip.conf`:

```ini
[novofon-trunk]
type=peer
host=sip.novofon.ru
fromdomain=sip.novofon.ru
insecure=port,invite
context=novofon-trunk-in
disallow=all
allow=alaw
allow=ulaw
dtmfmode=auto
directmedia=no
nat=force_rport,comedia
```

Настройте обработку входящих в `/etc/asterisk/extensions.conf`:

```ini
[novofon-trunk-in]
exten => _X.,1,NoOp(Incoming call from NovoFon TRUNK)
exten => _X.,n,Set(CALLERID(num)=${CALLERID(num)})
exten => _X.,n,Dial(SIP/101,30,tr)
exten => _X.,n,Voicemail(101@default,u)
exten => _X.,n,Hangup()
```

## Настройка через сценарии

### Создание входящих сценариев

Сценарии позволяют создавать сложную логику обработки входящих звонков[1]. Для направления на Asterisk:

1. **Перейдите в раздел** «Входящие сценарии»

2. **Нажмите** «Добавить сценарий»

3. **Задайте имя** сценария

4. **Настройте операции**:
   - Добавьте операцию «Переадресация»
   - Выберите тип «SIP URI» или «SIP TRUNK»
   - Укажите адрес вашего сервера

5. **Сохраните сценарий**

### Применение сценария к номеру

1. **Перейдите в** «Виртуальные номера»

2. **Выберите номер** и в поле «Переадресация на» выберите **«Сценарий»**

3. **Укажите созданный сценарий**

## Настройка переадресации через пользователя

### Создание пользователя для переадресации

Этот метод подходит для серверов с серыми IP-адресами:

1. **Создайте пользователя** в разделе «Пользователи АТС»

2. **Откройте настройки** пользователя, вкладка «ВАТС»

3. **В разделе «Телефоны»** нажмите «Добавить»

4. **Укажите параметры**:
   - Тип: «Номер переадресации»
   - Номер: адрес вашего сервера или телефонный номер
   - Включите переадресацию

5. **Настройте приоритет**: поставьте переадресацию выше SIP в списке

### Направление номера на пользователя

1. **В разделе «Виртуальные номера»** выберите номер

2. **В поле «Переадресация на»** выберите созданного пользователя

3. **Сохраните настройки**

## Работа с серыми IP-адресами

### Проблемы серых IP

Серые IP-адреса не доступны напрямую из интернета[5][6]. Для работы с NovoFon при наличии серого IP используйте:

1. **Переадресацию через телефонный номер**
2. **VPN-подключение**
3. **Проброс портов на роутере**

### Настройка проброса портов

Если ваш сервер находится за NAT, настройте проброс портов:

```bash
# Проброс SIP-порта
iptables -t nat -A PREROUTING -p udp --dport 5060 -j DNAT --to-destination 192.168.1.100:5060

# Проброс RTP-портов
iptables -t nat -A PREROUTING -p udp --dport 10000:20000 -j DNAT --to-destination 192.168.1.100
```

### Настройка Asterisk за NAT

В файле `/etc/asterisk/sip.conf` добавьте:

```ini
[general]
localnet=192.168.1.0/255.255.255.0
externip=ВАШ_ВНЕШНИЙ_IP
nat=force_rport,comedia
directmedia=no
```

## Настройка безопасности

### Firewall на сервере

Откройте необходимые порты:

```bash
# Для CentOS/RHEL
firewall-cmd --permanent --add-port=5060/udp
firewall-cmd --permanent --add-port=10000-20000/udp
firewall-cmd --reload

# Для Ubuntu/Debian
ufw allow 5060/udp
ufw allow 10000:20000/udp
```

### Ограничение доступа

Разрешите подключения только от IP-адресов NovoFon[2]:

```bash
# Разрешить подсеть NovoFon
iptables -A INPUT -s 37.139.38.0/24 -p udp --dport 5060 -j ACCEPT

# Запретить остальные подключения на SIP-порт
iptables -A INPUT -p udp --dport 5060 -j DROP
```

## Тестирование и отладка

### Проверка подключения

1. **Проверьте регистрацию** пиров в Asterisk:
   ```bash
   asterisk -rx "sip show peers"
   ```

2. **Проверьте входящие звонки** из консоли:
   ```bash
   asterisk -rvvv
   ```

3. **Тестовый звонок** с мобильного на ваш виртуальный номер

### Отладка проблем

#### Проблемы с подключением

- **Проверьте доступность** портов с внешней стороны
- **Убедитесь в правильности** настроек firewall
- **Проверьте логи** Asterisk на наличие ошибок

#### Проблемы с качеством звука

- **Проверьте настройки** кодеков (используйте alaw/ulaw)
- **Убедитесь в стабильности** интернет-соединения
- **Настройте QoS** для RTP-трафика

### Мониторинг звонков

Включите детальное логирование в `/etc/asterisk/logger.conf`:

```ini
[logfiles]
console => notice,warning,error
full => notice,warning,error,debug,verbose
```

## Дополнительные возможности

### Интеграция с API NovoFon

Для расширенного управления используйте API NovoFon[7]:

1. **Получите API-ключи** в личном кабинете
2. **Настройте webhook** для уведомлений о звонках
3. **Используйте Data API** для получения статистики

### Настройка уведомлений

Настройте уведомления о входящих звонках[8]:

1. **Перейдите в** «Настройки → Уведомления»
2. **Создайте уведомление** типа «Входящий звонок»
3. **Укажите webhook URL** вашего сервера
4. **Настройте условия** срабатывания

## Заключение

Настройка NovoFon для направления входящих звонков на сервер Asterisk включает несколько этапов:

1. **Выбор подходящего метода** в зависимости от типа IP-адреса
2. **Правильную настройку firewall** и сетевых параметров
3. **Корректную конфигурацию** как NovoFon, так и Asterisk
4. **Тестирование и отладку** для обеспечения стабильной работы

**Рекомендуемый подход**:
- Для серверов с белыми IP - используйте SIP URI
- Для серверов с серыми IP - используйте переадресацию через пользователя
- Для сложной логики - создавайте входящие сценарии
- Всегда тестируйте настройки перед внедрением в продакшен

При возникновении проблем обращайтесь в службу поддержки NovoFon или используйте детальное логирование для диагностики неполадок.