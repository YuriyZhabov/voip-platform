# Руководство по тестированию VoIP архитектур

## Обзор

Эта система позволяет безопасно тестировать различные архитектурные подходы к голосовому агенту без влияния на продакшн систему.

## Быстрый старт

### 1. Создание тестовой среды

```bash
# Создать среду для тестирования текущей архитектуры
./shared/scripts/test-env-manager.sh create env-a

# Создать среду для альтернативной архитектуры
./shared/scripts/test-env-manager.sh create env-b
```

### 2. Настройка переменных окружения

Отредактируйте файлы `.env.test` в каждой среде:

```bash
# Для среды A
nano env-a/.env.test

# Для среды B
nano env-b/.env.test
```

**Важно**: Используйте отдельные тестовые аккаунты Novofon!

### 3. Запуск тестовой среды

```bash
# Запустить среду A
./shared/scripts/test-env-manager.sh start env-a

# Проверить статус
./shared/scripts/test-env-manager.sh status env-a
```

### 4. Запуск тестов

```bash
# Тестировать одну среду
./shared/scripts/run-tests.sh test env-a

# Сравнительное тестирование
./shared/scripts/run-tests.sh compare env-a env-b

# Просмотр результатов
./shared/scripts/run-tests.sh results
```

## Архитектуры для тестирования

### Среда A: Текущая архитектура
```
Novofon → Asterisk → ARI → LiveKit Agent → AI Services
```

**Особенности:**
- Использует Asterisk REST Interface (ARI)
- LiveKit для обработки аудио
- Python агент с AI интеграцией

**Порты:**
- HTTP: 8081
- HTTPS: 8441
- SIP UDP: 5081
- SIP TCP: 5161
- Redis: 6371

### Среда B: Прямая интеграция
```
Novofon → Asterisk → Direct Python Agent → AI Services
```

**Особенности:**
- Прямая интеграция с Asterisk через AMI/AGI
- Без промежуточных слоев
- Упрощенная архитектура

**Порты:**
- HTTP: 8082
- HTTPS: 8442
- SIP UDP: 5082
- SIP TCP: 5162
- Redis: 6372

### Среда C: Микросервисная архитектура
```
Novofon → Asterisk → Message Queue → Multiple Agents → AI Services
```

**Особенности:**
- Использует очереди сообщений (Redis/RabbitMQ)
- Горизонтальное масштабирование
- Отказоустойчивость

**Порты:**
- HTTP: 8083
- HTTPS: 8443
- SIP UDP: 5083
- SIP TCP: 5163
- Redis: 6373

## Мониторинг

### Запуск системы мониторинга

```bash
cd testing/shared/monitoring
docker-compose -f docker-compose.monitoring.yml up -d
```

### Доступ к интерфейсам

- **Grafana**: http://localhost:3000 (admin/admin123)
- **Prometheus**: http://localhost:9090
- **Node Exporter**: http://localhost:9100
- **cAdvisor**: http://localhost:8080

### Метрики для анализа

1. **Производительность**
   - Время отклика Asterisk CLI
   - Использование CPU и памяти
   - Пропускная способность сети

2. **Надежность**
   - Успешность SIP регистрации
   - Стабильность ARI соединений
   - Количество ошибок

3. **Качество**
   - Задержка аудио
   - Качество распознавания речи
   - Время ответа AI сервисов

## Тестовые сценарии

### Базовое тестирование

```bash
# Проверка всех компонентов
./shared/scripts/run-tests.sh test env-a
```

Включает:
- ✅ Подключение к Asterisk
- ✅ SIP регистрация
- ✅ ARI интерфейс
- ✅ База данных
- ✅ Redis
- ✅ Диалплан
- ✅ Производительность

### Сравнительное тестирование

```bash
# Сравнить две архитектуры
./shared/scripts/run-tests.sh compare env-a env-b
```

Генерирует отчет с:
- Сравнением производительности
- Анализом надежности
- Рекомендациями по выбору

### Нагрузочное тестирование

```bash
# Тест с 10 одновременными звонками
./shared/scripts/run-tests.sh load env-a 10
```

**Примечание**: Требует настройки SIPp для полноценного тестирования.

## Безопасность и изоляция

### Сетевая изоляция

Каждая среда использует:
- Отдельную Docker сеть
- Уникальные порты
- Изолированные volumes

### Изоляция данных

- Отдельные базы данных
- Независимые Redis инстансы
- Изолированные логи

### Откат изменений

```bash
# Остановить среду
./shared/scripts/test-env-manager.sh stop env-a

# Полная очистка
./shared/scripts/test-env-manager.sh clean env-a
```

## Анализ результатов

### Просмотр результатов

```bash
# Последние результаты
./shared/scripts/run-tests.sh results

# Детальный анализ
cat testing/results/test_results.csv
```

### Критерии оценки

1. **Производительность (40%)**
   - Время отклика < 2 секунд
   - Использование CPU < 50%
   - Использование памяти < 1GB

2. **Надежность (30%)**
   - Успешность тестов > 90%
   - Стабильность SIP соединений
   - Обработка ошибок

3. **Простота поддержки (20%)**
   - Сложность конфигурации
   - Количество компонентов
   - Документированность

4. **Масштабируемость (10%)**
   - Поддержка множественных звонков
   - Горизонтальное масштабирование
   - Время развертывания

## Рекомендации по выбору архитектуры

### Выбирайте Архитектуру A, если:
- ✅ Нужна максимальная функциональность
- ✅ Планируется интеграция с LiveKit
- ✅ Требуется богатый набор AI функций
- ❌ Готовы к сложности настройки

### Выбирайте Архитектуру B, если:
- ✅ Нужна простота и надежность
- ✅ Ограниченные ресурсы
- ✅ Быстрое развертывание
- ❌ Ограниченная функциональность

### Выбирайте Архитектуру C, если:
- ✅ Высокие требования к масштабируемости
- ✅ Нужна отказоустойчивость
- ✅ Планируется большая нагрузка
- ❌ Сложность управления

## Устранение неполадок

### Проблемы с запуском

```bash
# Проверить логи
./shared/scripts/test-env-manager.sh logs env-a

# Проверить изоляцию
./shared/scripts/test-env-manager.sh check env-a

# Пересоздать среду
./shared/scripts/test-env-manager.sh clean env-a
./shared/scripts/test-env-manager.sh create env-a
```

### Конфликты портов

Если порты заняты, измените их в файле `docker-compose.test-*.yml`:

```yaml
ports:
  - "8091:80"  # Вместо 8081
  - "8451:443" # Вместо 8441
```

### Проблемы с SIP

1. Проверьте настройки Novofon в `.env.test`
2. Убедитесь, что используете тестовый аккаунт
3. Проверьте firewall настройки

## Следующие шаги

1. **Создайте первую тестовую среду**
2. **Настройте мониторинг**
3. **Запустите базовые тесты**
4. **Проанализируйте результаты**
5. **Выберите оптимальную архитектуру**
6. **Задокументируйте решение**

---

*Для вопросов и поддержки создавайте Issues в репозитории проекта.*