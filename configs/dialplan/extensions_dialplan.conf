; Диалплан для VoIP системы с LiveKit
; Этот файл содержит диалплан для обработки входящих звонков

; Диалплан для входящих звонков от Novofon
[from-novofon]
exten => 79952227978,1,NoOp(Incoming call from Novofon to ${EXTEN})
 same => n,Set(CHANNEL(hangup_handler_push)=hangup-handler,s,1)
 same => n,Set(CALLERID(name)=VoIP-AI-Call)
 same => n,Set(__CALL_START_TIME=${EPOCH})
 same => n,Set(__CALLER_NUMBER=${CALLERID(num)})
 same => n,Answer()
 same => n,Wait(0.5)
 same => n,NoOp(Starting AI Agent for caller ${CALLERID(num)} at ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
 same => n,Stasis(livekit-agent,incoming,${CALLERID(num)},${EXTEN})
 same => n,Hangup()

; Обработка неизвестных номеров от Novofon
exten => _+7XXXXXXXXXX,1,NoOp(Unknown incoming number ${EXTEN})
 same => n,Goto(79952227978,1)

exten => _7XXXXXXXXXX,1,NoOp(Unknown incoming number ${EXTEN})
 same => n,Goto(79952227978,1)

; Контекст для LiveKit моста
[livekit-bridge]
exten => _X.,1,NoOp(LiveKit Bridge for room ${EXTEN})
 same => n,Set(CHANNEL(hangup_handler_push)=bridge-hangup-handler,s,1)
 same => n,Answer()
 same => n,NoOp(Bridge channel created for room ${EXTEN})
 same => n,Stasis(livekit-agent,bridge,${EXTEN})
 same => n,Hangup()

; Обработчик завершения звонка
[hangup-handler]
exten => s,1,NoOp(Call hangup handler for ${CHANNEL})
 same => n,Set(CALL_DURATION=$[${EPOCH} - ${__CALL_START_TIME}])
 same => n,NoOp(Call duration: ${CALL_DURATION} seconds)
 same => n,NoOp(Caller: ${__CALLER_NUMBER})
 same => n,Return()

; Обработчик завершения моста
[bridge-hangup-handler]
exten => s,1,NoOp(Bridge hangup handler for ${CHANNEL})
 same => n,NoOp(Bridge channel terminated)
 same => n,Return()

; Диалплан для тестовых звонков
[from-internal-custom]
; Тест AI агента
exten => 9999,1,NoOp(Test AI Agent call to ${EXTEN})
 same => n,Set(CALLERID(num)=TEST-9999)
 same => n,Set(CALLERID(name)=AI-Test-Call)
 same => n,Answer()
 same => n,Wait(0.5)
 same => n,Playback(beep)
 same => n,Stasis(livekit-agent,test,${CALLERID(num)},${EXTEN})
 same => n,Hangup()

; Тест эхо
exten => 8888,1,NoOp(Echo test call)
 same => n,Answer()
 same => n,Playback(demo-echotest)
 same => n,Echo()
 same => n,Hangup()

; Тест воспроизведения
exten => 7777,1,NoOp(Playback test call)
 same => n,Answer()
 same => n,Playback(demo-congrats)
 same => n,Playback(hello-world)
 same => n,Wait(2)
 same => n,Hangup()

; Тест записи
exten => 6666,1,NoOp(Record test call)
 same => n,Answer()
 same => n,Playback(beep)
 same => n,Record(/tmp/test-recording.wav,10,k)
 same => n,Playback(beep)
 same => n,Playback(/tmp/test-recording)
 same => n,Hangup()

; Контекст для обработки ошибок
[error-handler]
exten => s,1,NoOp(Error handler activated)
 same => n,Answer()
 same => n,Playback(im-sorry)
 same => n,Playback(something-went-wrong)
 same => n,Wait(2)
 same => n,Hangup()

; Контекст для отладки
[debug-context]
exten => _X.,1,NoOp(Debug: Extension ${EXTEN} called)
 same => n,NoOp(Debug: Caller ID ${CALLERID(all)})
 same => n,NoOp(Debug: Channel ${CHANNEL})
 same => n,NoOp(Debug: Context ${CONTEXT})
 same => n,Answer()
 same => n,Playback(demo-congrats)
 same => n,Hangup()